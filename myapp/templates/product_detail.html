{% load static %}
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ product.name }}</title>

    <!-- ‚úÖ CSS -->
    <link rel="stylesheet" href="{% static 'styles/product_detail.css' %}">

    <!-- ‚úÖ Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

    <!-- ‚úÖ Slick Slider -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick-theme.min.css">
</head>
<body>

    <!-- üå∏ Navbar -->
    <header>
        <nav class="navbar">
            <div class="logo">
                <a href="{% url 'home' %}">
                    <img src="{% static 'media/logo.jpg' %}" alt="Shop Logo">
                </a>
            </div>
            <ul class="nav-links">
                <li><a href="{% url 'home' %}" class="nav-link">üè† Home</a></li>
                <li><a href="{% url 'profile' request.user.id %}" class="nav-link">üìÑ Profile</a></li>
                <li><a href="{% url 'product_list' %}" class="nav-link {% if request.path == '/products/' %}active{% endif %}">üõç Products</a></li>
                <li><a href="{% url 'order_history' %}" class="nav-link {% if request.path == '/order/history/' %}active{% endif %}">üìú Order History</a></li>
                <li><a href="{% url 'cart' %}" class="nav-link {% if request.path == '/cart/' %}active{% endif %}">üõí Cart</a></li>
            </ul>
        </nav>
    </header>

    <!-- üì¶ Product Detail Section -->
    <div class="product-container">
        <div class="product-box">
            <!-- üîπ Product Image Slider -->
            <div class="product-slider">
                {% if product.image %}
                    <div><img src="{{ product.image.url }}" alt="{{ product.name }}"></div>
                {% endif %}
                {% for img in product.extra_images.all %}
                    <div><img src="{{ img.image.url }}" alt="Extra Image"></div>
                {% endfor %}
            </div>

            <!-- ‚ÑπÔ∏è Product Details -->
            <div class="product-info">
                <h2>{{ product.name }}</h2>
                <p class="price">üí∞ ‡∏£‡∏≤‡∏Ñ‡∏≤: ‡∏ø{{ product.price }}</p>
                <p class="stock">üì¶ ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: 
                    {% if product.stock > 0 %}
                        {{ product.stock }}
                    {% else %}
                        <span class="out-of-stock">‚ùå ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î</span>
                    {% endif %}
                </p>
                <p class="sold">üî• ‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß: {{ product.total_sold }} ‡∏ä‡∏¥‡πâ‡∏ô</p>
                <p class="description">üìú ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: {{ product.description }}</p>
                <p class="category">üìå ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà: {{ product.get_category_display }}</p>
                <p class="seller">üè™ ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤: 
                    <a href="{% url 'store_detail' product.seller.id %}" class="store-link">
                        <strong>{{ product.seller.store_name }}</strong>
                    </a>
                </p>

                <!-- üõí Add to Cart -->
                <div class="cart-section">
                    {% if product.stock > 0 %}
                        <button type="button" class="btn btn-success add-to-cart-btn" data-product-id="{{ product.id }}">
                            ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
                        </button>
                    {% else %}
                        <button class="btn btn-secondary" disabled>‚ùå ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î</button>
                    {% endif %}
                </div>
                <!-- üì§ Share Button -->
                <div class="share-section">
                    <button class="btn btn-info share-btn" onclick="shareProduct()">
                        üì§ ‡πÅ‡∏ä‡∏£‡πå‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                    </button>
                </div>

                <!-- üõç ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ -->
                <p id="cart-message" style="display: none; text-align: center; font-weight: bold;"></p>

                <!-- üîô ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
                <div class="cart-section">
                    <a href="{% url 'product_list' %}" class="btn btn-secondary back-btn">
                        üîô ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- üåü ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
    <div class="reviews-section">
        <h3>üåü ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>

        {% for review in product.reviews.all %}
            <div class="review-box">
                <p><strong>{{ review.user.username }}</strong>: ‚≠ê {{ review.rating }}/5</p>
                <p>üõí ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏à‡∏≤‡∏Å‡∏£‡πâ‡∏≤‡∏ô <strong>{{ review.order.seller.store_name }}</strong></p>
                <p>üõç ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: <strong>{{ review.product.name }}</strong></p>
                <p>{{ review.comment }}</p>

                <!-- üé• ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û & ‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÉ‡∏ô‡∏£‡∏µ‡∏ß‡∏¥‡∏ß -->
                <div class="review-media">
                    {% for media in review.media.all %}
                        {% if media.media_type == "image" %}
                            <img src="{{ media.file.url }}" alt="Review Image" class="review-image">
                        {% elif media.media_type == "video" %}
                            <video controls class="review-video">
                                <source src="{{ media.file.url }}" type="video/mp4">
                            </video>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        {% empty %}
            <p>‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</p>
        {% endfor %}
    </div>
    <form action="{% url 'product_detail' product.id %}" method="post">
        {% csrf_token %}
        <button type="submit" class="btn btn-primary">üìä ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</button>
    </form>
    
    <!-- ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏£‡∏µ‡∏ß‡∏¥‡∏ß -->
    <h3>üåü ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
    
    {% for review in reviews %}
        <div class="review-box">
            <p><strong>{{ review.user.username }}</strong>: ‚≠ê {{ review.rating }}/5</p>
            <p>{{ review.comment }}</p>
    
            <!-- ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• sentiment -->
            {% if review.analysis_done %}
                <p>üîç ‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå: 
                    {% if review.sentiment == "positive" %}
                        üòä ‡∏ö‡∏ß‡∏Å
                    {% elif review.sentiment == "negative" %}
                        üò° ‡∏•‡∏ö
                    {% else %}
                        üòê ‡∏Å‡∏•‡∏≤‡∏á
                    {% endif %}
                </p>
            {% else %}
                <p>üü° ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</p>
            {% endif %}
        </div>
    {% empty %}
        <p>‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</p>
    {% endfor %}
    <div class="review-summary">
        <h3>üîç ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÇ‡∏î‡∏¢ AI</h3>
        <p>{{ summary }}</p>
        <p>üòä ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÄ‡∏ä‡∏¥‡∏á‡∏ö‡∏ß‡∏Å: {{ positive_ratio|floatformat:2 }}%</p>
        <p>üòê ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏Å‡∏•‡∏≤‡∏á‡πÜ: {{ neutral_ratio|floatformat:2 }}%</p>
        <p>üò° ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏ö: {{ negative_ratio|floatformat:2 }}%</p>
    </div>

 <!-- ‚úÖ ‡∏õ‡∏∏‡πà‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå & ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß -->
 <form method="POST">
    {% csrf_token %}
    <button type="submit" name="summarize_reviews" class="btn summarize">üìñ ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</button>
</form>

<!-- ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏£‡∏∏‡∏õ -->
{% if summary %}
<div class="review-summary">
    <h2>üìå ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
    <p>{{ summary }}</p>
</div>
{% endif %}
    
    

<!-- ‚úÖ JavaScript -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick.min.js"></script>
<script>
    $(document).ready(function(){
        $('.product-slider').slick({
            dots: true,
            infinite: true,
            speed: 300,
            slidesToShow: 1,
            adaptiveHeight: true
        });

        // üõí ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏ö‡∏ö AJAX
        $(".add-to-cart-btn").click(function(event) {
            event.preventDefault();  // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏ã‡πâ‡∏≥

            let productId = $(this).data("product-id");
            let cartMessage = $("#cart-message");

            $.ajax({
                url: `/cart/add/${productId}/`,  // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL
                method: "POST",
                headers: { "X-CSRFToken": "{{ csrf_token }}" },
                dataType: "json",
                success: function(response) {
                    if (response.success) {
                        $("#cart-count").text(response.cart_count); // üîÑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
                        cartMessage.text("‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!").css("color", "green").fadeIn().delay(2000).fadeOut();
                    } else {
                        cartMessage.text("‚ùå " + response.message).css("color", "red").fadeIn().delay(2000).fadeOut();
                    }
                },
                error: function() {
                    cartMessage.text("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà").css("color", "red").fadeIn().delay(2000).fadeOut();
                }
            });
        });
    });

    // üì§ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏ä‡∏£‡πå‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
    function shareProduct() {
        let productUrl = window.location.href;
        if (navigator.share) {
            navigator.share({
                title: "{{ product.name }}",
                text: "‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏∏‡∏î‡∏Æ‡∏¥‡∏ï‡∏à‡∏≤‡∏Å‡∏£‡πâ‡∏≤‡∏ô {{ product.seller.store_name }}",
                url: productUrl
            }).then(() => console.log("Shared successfully!"))
            .catch(error => console.error("Error sharing:", error));
        } else {
            navigator.clipboard.writeText(productUrl);
            alert("üìã ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß!");
        }
    }

</script>

</body>
</html>
