{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile Page</title>
    <link rel="stylesheet" href="{% static 'styles/profile.css' %}">

    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <!-- ใช้ Font Awesome จาก CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" defer></script>

    <!-- <script src="{% static 'js/profile.js' %}" defer></script> -->
    <script src="{% static 'js/post.js' %}" defer></script>
    <script src="{% static 'js/like.js' %}" defer></script>
    <script src="{% static 'js/share.js' %}" defer></script>
    <script src="{% static 'js/delete.js' %}" defer></script>
    <script src="{% static 'js/commentProfile.js' %}" defer></script>
    <script src="{% static 'js/savelist.js' %}" defer></script>
    <script src="{% static 'js/follow.js' %}" defer></script>
</head>

<body>
    <div class="wrapper">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <img src="{% static 'media/logo.jpg' %}" alt="Logo" class="logo-img">
            </div>
            <nav>
                <ul class="nav">
                    <li><a href="{% url 'home' %}" class="nav-link"><i class="fas fa-home"></i> <span>หน้าหลัก</span></a></li>
                    <li><a href="{% url 'community_list' %}" class="nav-link"><i class="fas fa-users"></i> <span>ชุมชน</span></a></li>
                    <li><a href="{% url 'savelist' %}" class="nav-link"><i class="fas fa-bookmark"></i> <span>รายการบันทึก</span></a></li>
                    <li><a href="{% url 'profile' request.user.id %}" class="nav-link active"><i class="fas fa-user"></i> <span>โปรไฟล์</span></a></li>
                    <li><a href="{% url 'product_list' %}" class="nav-link"><i class="fas fa-shopping-cart"></i> <span>รายการสินค้า</span></a></li>
                    <li><a href="{% url 'notifications' %}" class="nav-link"><i class="fas fa-bell"></i> <span>การแจ้งเตือน</span></a></li>
                </ul>
            </nav>
            <div class="welcome-logout">
                <p>ยินดีต้อนรับ, <b>{{ request.user.username }}</b></p>
                <form action="{% url 'logout' %}" method="post" class="mt-2">
                    {% csrf_token %}
                    <button type="submit" class="logout-btn">ออกจากระบบ</button>
                </form>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="content">
            <!-- Profile Header -->
            <header class="profile-header">
                <div class="profile-picture">
                    {% if user.member_profile.profile_picture %}
                        <img src="{{ user.member_profile.profile_picture.url }}" alt="Profile Picture" class="profile-header-img">
                    {% else %}
                        <img src="{% static 'images/default-profile.png' %}" alt="Default Profile Picture" class="profile-img">
                    {% endif %}
                </div>
                
                <h2 class="username">{{ user.username }}</h2>
                
                <!-- Follow Stats -->
                <div class="follow-stats">
                    <span><strong id="followers-count">{{ user.followers.count }}</strong> ผู้ติดตาม</span>
                    <span><strong id="following-count">{{ user.following.count }}</strong> กำลังติดตาม</span>
                </div>
                
                <!-- Follow/Edit Button -->
                {% if user != request.user %}
                    <button id="follow-button"
                            data-user-id="{{ user.id }}"
                            class="follow-btn {% if request.user in user.followers.all %}following{% endif %}">
                        {% if request.user in user.followers.all %}เลิกติดตาม{% else %}ติดตาม{% endif %}
                    </button>    
                {% endif %}
                
                {% if is_own_profile %}
                    <a href="{% url 'profile_management' %}" class="edit-profile-btn">แก้ไขโปรไฟล์</a>
                {% endif %}
            </header>

            <!-- Create Post Section -->
            <div class="create-post">
                <h5>สร้างโพสต์ใหม่</h5>
                <form id="postForm" action="{% url 'create_post' %}" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <textarea name="content" class="post-textarea" placeholder="คุณกำลังคิดอะไรอยู่?" required></textarea>
                    
                    <div class="media-buttons">
                        <label for="postImages" class="media-btn image-btn">
                            <i class="fas fa-image"></i> เพิ่มรูปภาพ
                        </label>
                        <input type="file" name="images" id="postImages" accept="image/*" multiple hidden>
                        
                        <label for="postVideos" class="media-btn video-btn">
                            <i class="fas fa-video"></i> เพิ่มวิดีโอ
                        </label>
                        <input type="file" name="videos" id="postVideos" accept="video/*" multiple hidden>
                    </div>
                    
                    <button type="submit" class="post-btn">โพสต์</button>
                </form>
            </div>

            <!-- User Posts -->
            <div class="posts mt-4">
                <h3>โพสต์ของฉัน</h3>

                 <!-- ✅ Posts Section -->
                {% for post in posts %}
                    {% if not post.is_reported %}
                        <div class="post card p-3 mb-3 shadow-sm" id="post-{{ post.id }}">
                            <!-- User Info -->
                            <div class="user-info d-flex align-items-center">
                                {% if post.user.member_profile.profile_picture %}
                                    <img src="{{ post.user.member_profile.profile_picture.url }}" class="profile-img me-2 rounded-circle" width="40" height="40">
                                {% else %}
                                    <img src="{% static 'images/default-profile.png' %}" class="profile-img me-2 rounded-circle" width="40" height="40">
                                {% endif %}
                            
                                <b>{{ post.user.username }}</b>
                                <small class="text-muted">{{ post.created_at|date:"F j, Y, g:i a" }}</small>

                                <!-- Follow Button -->
                                {% if post.user.id != request.user.id %}
                                    <form method="POST" action="{% url 'follow_user' post.user.id %}" class="ms-2 follow-form">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-sm {% if post.user.id in following_users %}btn-danger{% else %}btn-outline-primary{% endif %}">
                                            {% if post.user.id in following_users %}ติดตามแล้ว{% else %}ติดตาม{% endif %}
                                        </button>
                                    </form>
                                {% endif %}
                            </div>

                            <!-- Post Content -->
                            <p>{{ post.content }}</p>

                            <!-- Post Media -->
                            {% if post.media.all %}
                                <div class="post-media mb-3">
                                    {% for media in post.media.all|slice:":4" %}
                                        <div class="media-item">
                                            {% if media.media_type == "image" %}
                                                <img src="{{ media.file.url }}" class="rounded img-fluid" alt="Post image">
                                            {% elif media.media_type == "video" %}
                                                <video src="{{ media.file.url }}" controls class="rounded img-fluid"></video>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            
                            

                            <!-- Actions -->
                            <div class="actions mt-2 d-flex gap-2">
                                <button class="btn like-btn" data-post-id="{{ post.id }}">
                                    <i class="fas fa-heart"></i> ถูกใจ
                                </button>
                                <span id="like-count-{{ post.id }}">{{ post.likes.count }} Likes</span>
                                <button class="btn share-btn" data-post-id="{{ post.id }}">
                                    <i class="fas fa-share-alt"></i> แชร์
                                </button>
                                <!-- <button class="btn btn-light save-btn" data-post-id="{{ post.id }}">
                                     {% if post in request.user.saved_posts.all %}Unsave{% else %}Save{% endif %}
                                </button>   -->
                                <button class="btn save-btn" data-post-id="{{ post.id }}">
                                    {% if post in request.user.saved_posts.all %}
                                        <i class="fas fa-bookmark"></i> ยกเลิกบันทึก
                                    {% else %}
                                        <i class="far fa-bookmark"></i> บันทึก
                                    {% endif %}
                                </button>
                                {% if request.user == post.user %}
                                    <a href="{% url 'edit_post' post.id %}" class="btn">
                                        <i class="fas fa-edit"></i> แก้ไข
                                    </a>                          
                                    <button class="btn btn-danger delete-btn" data-post-id="{{ post.id }}">
                                        <i class="fas fa-trash"></i> ลบ
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Comments Section -->
                        <!-- Comments Section -->
                        <div class="comments-section">
                            <div class="comments-header">
                                <h3><i class="fas fa-comments"></i> ความคิดเห็น <span class="comment-count">{{ post.comments.all|length }}</span></h3>
                            </div>
                            
                            <div class="comment-list" id="comments-{{ post.id }}">
                                {% for comment in post.comments.all %}
                                    <div class="comment-item" id="comment-{{ comment.id }}">
                                        <div class="comment-avatar">
                                            {% if comment.user.member_profile.profile_picture %}
                                                <img src="{{ comment.user.member_profile.profile_picture.url }}" alt="{{ comment.user.username }}">
                                            {% else %}
                                                <img src="{% static 'images/default-profile.png' %}" alt="Default profile">
                                            {% endif %}
                                        </div>
                                        
                                        <div class="comment-content">
                                            <div class="comment-bubble {% if comment.user == request.user %}own-comment{% endif %}">
                                                <div class="comment-author">{{ comment.user.username }}</div>
                                                <div class="comment-text">{{ comment.content }}</div>
                                            </div>
                                            
                                            <div class="comment-meta">
                                                <span class="comment-time">{{ comment.created_at|timesince }} ที่แล้ว</span>
                                                
                                                {% if request.user == comment.user %}
                                                    <div class="comment-actions">
                                                        <button class="action-btn edit-comment" data-comment-id="{{ comment.id }}">
                                                            <i class="fas fa-edit"></i> แก้ไข
                                                        </button>
                                                        <button class="action-btn delete-comment" data-comment-id="{{ comment.id }}">
                                                            <i class="fas fa-trash"></i> ลบ
                                                        </button>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                {% empty %}
                                    <div class="no-comments">
                                        <i class="fas fa-comment-slash"></i>
                                        <p>ยังไม่มีความคิดเห็น เป็นคนแรกที่แสดงความคิดเห็น!</p>
                                    </div>
                                {% endfor %}
                            </div>
                            
                            <!-- Add Comment Form -->
                            <form class="comment-form" data-post-id="{{ post.id }}">
                                {% csrf_token %}
                                <div class="comment-form-avatar">
                                    {% if request.user.member_profile.profile_picture %}
                                        <img src="{{ request.user.member_profile.profile_picture.url }}" alt="{{ request.user.username }}">
                                    {% else %}
                                        <img src="{% static 'images/default-profile.png' %}" alt="Default profile">
                                    {% endif %}
                                </div>
                                <div class="comment-input-wrapper">
                                    <input type="text" name="content" class="comment-input" placeholder="เขียนความคิดเห็น..." autocomplete="off">
                                    <button type="submit" class="comment-submit" disabled>
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Comment Notification Template -->
                        <div id="comment-notification" class="comment-notification">
                            <i class="fas fa-check-circle"></i>
                            <span id="notification-message"></span>
                            <button class="comment-notification-close">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    {% else %}
                        <div class="no-posts">
                            <i class="fas fa-inbox"></i>
                            <p>ยังไม่มีโพสต์</p>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </main>

        <!-- JavaScript -->
        <script>
            // Media preview functionality
            document.addEventListener('DOMContentLoaded', function() {
                // Preview images before upload
                const postImages = document.getElementById('postImages');
                const imagePreview = document.getElementById('imagePreview');
                
                if (postImages && imagePreview) {
                    postImages.addEventListener('change', function() {
                        imagePreview.innerHTML = '';
                        
                        if (this.files) {
                            const fileCount = Math.min(this.files.length, 4);
                            imagePreview.classList.add('d-flex', 'flex-wrap', 'gap-2');
                            
                            for (let i = 0; i < fileCount; i++) {
                                const reader = new FileReader();
                                reader.onload = function(e) {
                                    const imgPreview = document.createElement('div');
                                    imgPreview.className = 'preview-item position-relative';
                                    imgPreview.innerHTML = `
                                        <img src="${e.target.result}" class="img-thumbnail" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px;">
                                        <button type="button" class="btn-close position-absolute top-0 end-0 bg-danger text-white" style="padding: 2px;"></button>
                                    `;
                                    imagePreview.appendChild(imgPreview);
                                    
                                    // Remove image on close button click
                                    imgPreview.querySelector('.btn-close').addEventListener('click', function() {
                                        imgPreview.remove();
                                    });
                                }
                                reader.readAsDataURL(this.files[i]);
                            }
                            
                            if (this.files.length > 4) {
                                const moreIndicator = document.createElement('div');
                                moreIndicator.className = 'more-indicator bg-light rounded p-2 d-flex align-items-center justify-content-center';
                                moreIndicator.style.width = '100px';
                                moreIndicator.style.height = '100px';
                                moreIndicator.innerHTML = `<span>+${this.files.length - 4} เพิ่มเติม</span>`;
                                imagePreview.appendChild(moreIndicator);
                            }
                        }
                    });
                }
            });
        </script>
    </div>
</body>
    <!-- <script>
        document.addEventListener('DOMContentLoaded', function() {
            // ฟังก์ชันปุ่มติดตาม
            const followButton = document.getElementById('follow-button');
            if (followButton) {
                followButton.addEventListener('click', function() {
                    const userId = this.getAttribute('data-user-id');
                    
                    fetch(`/follow/${userId}/`, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // อัพเดทปุ่มและจำนวนผู้ติดตาม
                            if (data.is_following) {
                                followButton.textContent = 'เลิกติดตาม';
                                followButton.classList.add('following');
                            } else {
                                followButton.textContent = 'ติดตาม';
                                followButton.classList.remove('following');
                            }
                            
                            // อัพเดทจำนวนผู้ติดตาม
                            document.getElementById('followers-count').textContent = data.followers_count;
                        }
                    })
                    .catch(error => console.error('Error:', error));
                });
            }

            // แสดงชื่อไฟล์เมื่อเลือกไฟล์
            const imageInput = document.getElementById('postImages');
            const videoInput = document.getElementById('postVideos');
            const imageLabel = document.querySelector('label[for="postImages"]');
            const videoLabel = document.querySelector('label[for="postVideos"]');

            if (imageInput && imageLabel) {
                imageInput.addEventListener('change', function() {
                    const fileCount = this.files.length;
                    if (fileCount > 0) {
                        imageLabel.innerHTML = `<i class="fas fa-image"></i> ${fileCount} รูปถูกเลือก`;
                    } else {
                        imageLabel.innerHTML = `<i class="fas fa-image"></i> เพิ่มรูปภาพ`;
                    }
                });
            }

            if (videoInput && videoLabel) {
                videoInput.addEventListener('change', function() {
                    const fileCount = this.files.length;
                    if (fileCount > 0) {
                        videoLabel.innerHTML = `<i class="fas fa-video"></i> ${fileCount} วิดีโอถูกเลือก`;
                    } else {
                        videoLabel.innerHTML = `<i class="fas fa-video"></i> เพิ่มวิดีโอ`;
                    }
                });
            }
            
            // เพิ่มคลาส active ให้กับปุ่มไลค์เมื่อกด
            const likeBtns = document.querySelectorAll('.like-btn');
            likeBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const heartIcon = this.querySelector('i');
                    if (heartIcon.classList.contains('far')) {
                        heartIcon.classList.remove('far');
                        heartIcon.classList.add('fas');
                    } else {
                        heartIcon.classList.remove('fas');
                        heartIcon.classList.add('far');
                    }
                });
            });
            
            // เพิ่มคลาส active ให้กับปุ่มบันทึกเมื่อกด
            const saveBtns = document.querySelectorAll('.save-btn');
            saveBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const bookmarkIcon = this.querySelector('i');
                    const actionText = this.querySelector('.action-text');
                    if (bookmarkIcon.classList.contains('far')) {
                        bookmarkIcon.classList.remove('far');
                        bookmarkIcon.classList.add('fas');
                        actionText.textContent = 'เลิกบันทึก';
                    } else {
                        bookmarkIcon.classList.remove('fas');
                        bookmarkIcon.classList.add('far');
                        actionText.textContent = 'บันทึก';
                    }
                });
            });
            
            // แสดงความคิดเห็นใหม่ทันที
            const commentForms = document.querySelectorAll('.comment-form');
            commentForms.forEach(form => {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const postId = this.getAttribute('data-post-id');
                    const input = this.querySelector('.comment-input');
                    const content = input.value.trim();
                    
                    if (content) {
                        // ในสถานการณ์จริงคุณจะใช้ AJAX ส่งข้อมูลไปยังเซิร์ฟเวอร์
                        // แต่ในตัวอย่างนี้เราจะแค่เพิ่มความคิดเห็นในหน้าเว็บ
                        const commentsList = document.getElementById(`comments-${postId}`);
                        const newComment = document.createElement('div');
                        newComment.classList.add('comment');
                        
                        const username = document.createElement('span');
                        username.classList.add('comment-user');
                        username.textContent = '{{ request.user.username }}:';
                        
                        const commentContent = document.createElement('span');
                        commentContent.classList.add('comment-content');
                        commentContent.textContent = content;
                        
                        newComment.appendChild(username);
                        newComment.appendChild(commentContent);
                        commentsList.appendChild(newComment);
                        
                        input.value = '';
                    }
                });
            });
        });
    </script>
</body>
</html> -->